import"../chunks/CWj6FrbW.js";import{i as Me}from"../chunks/D_KrGeLK.js";import{o as $e,s as R,e as x}from"../chunks/Bvhiy7hU.js";import{n as Te,c as Se,f as Fe,a as p,q as Ce,t as e,u as L,v as a,o as S,w as l,x as i,y as d,z as Z,A as ne,B as se}from"../chunks/D-jx113l.js";import{i as z}from"../chunks/De-dCT7C.js";import{s as De,e as le,i as de}from"../chunks/BdJh3ayb.js";import{r as ce,b as ue}from"../chunks/-wvKRKOT.js";import{g as te}from"../chunks/Gws94pYq.js";import{s as ve}from"../chunks/B6q9zrgW.js";import{m as T}from"../chunks/C1k9nGEd.js";var Pe=S('<div class="svelte-ibhmaj"> </div>'),Re=S('<div class="suggestions rounded-lg svelte-ibhmaj"></div>'),ze=S('<div class="svelte-ibhmaj"> </div>'),Ee=S('<div class="suggestions rounded-lg svelte-ibhmaj"></div>'),Ie=S('<div class="order-form svelte-ibhmaj" style="position: relative;"><div style="position:relative; display:flex; align-items:center;"><input type="text" placeholder="Lokasi Penjemputan" class="rounded-lg svelte-ibhmaj" style="flex:1; padding-right:2.2rem;"/> <button type="button" class="gunakan-lokasi-button svelte-ibhmaj" aria-label="Gunakan lokasi sekarang" style="position:absolute; right:0.3rem; background:transparent; border:none; color:#007bff; font-size:1.3rem; padding:0; height:1.8rem; width:1.8rem; display:flex; align-items:center; justify-content:center; cursor:pointer;"><span aria-hidden="true">üìç</span></button> <!></div> <div style="position:relative;"><input type="text" placeholder="Lokasi Tujuan" class="rounded-lg svelte-ibhmaj"/> <!></div> <button class="order-button rounded-lg svelte-ibhmaj">Cari Rute & Estimasi</button></div>'),Oe=S('<div class="route-info route-panel rounded-lg svelte-ibhmaj" style="position:relative; max-width:400px; margin:rem auto 0 auto;"><button aria-label="Kembali ke form" style="position:absolute; left:0.5rem; top:0.5rem; background:none; border:none; font-size:1.1rem; color:#007bff; cursor:pointer; padding:0.18rem 0.6rem 0.18rem 0.18rem; z-index:2; line-height:1;">‚Üê</button> <div style="text-align:center; padding-top:0.2rem; padding-left:2.2rem;"><p style="margin-top:0.2rem;" class="svelte-ibhmaj"><strong>Jarak:</strong> </p> <p class="svelte-ibhmaj"><strong>Waktu Tempuh:</strong> </p> <p class="svelte-ibhmaj"><strong>Tarif:</strong> </p></div> <button class="cari-driver-button rounded-lg svelte-ibhmaj" style="margin-top: 1.2rem; width: 100%;"><!></button></div>'),Ae=S("<div> </div>"),Ge=S('<div class="home-container svelte-ibhmaj"><header class="header svelte-ibhmaj"><div><strong class="svelte-ibhmaj"> </strong></div> <button class="logout-button svelte-ibhmaj">Logout</button></header> <div class="map-placeholder svelte-ibhmaj" id="map"><p class="svelte-ibhmaj">Memuat peta...</p></div> <!> <!> <!></div>');function Ve(me,pe){Te(pe,!1);let W=L(null),F=L(""),H=L(""),E=L([]),I=L([]),g=null,M=null,b=L(null),U=L(!1),r,O=null,K=L(!1),n=L(""),_=null,A=null;const ge=2e3,fe=async()=>{if(!O){e(n,"Lokasi saat ini tidak tersedia.");return}const[o,t]=O;try{const u=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${t}&lon=${o}`)).json();e(F,u.display_name),g=[o,t],e(n,""),_&&_.remove(),r&&(_=new T.Marker({color:"#007bff"}).setLngLat([o,t]).addTo(r),r.flyTo({center:[o,t],zoom:r.getZoom()}))}catch(c){console.error("Error fetching current location address:",c),e(n,"Gagal mendapatkan alamat dari lokasi saat ini.")}};$e(async()=>{const{data:{session:o}={}}=await ve.auth.getSession();if(!o)return te("/login");e(W,o.user),navigator.geolocation.getCurrentPosition(async t=>{O=[t.coords.longitude,t.coords.latitude],r=new T.Map({container:"map",style:"https://api.maptiler.com/maps/streets-v2/style.json?key=sfvOnNJOOuOfsE6IJMSR",center:O,zoom:13}),r.addControl(new T.NavigationControl,"top-right");try{const u=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${t.coords.latitude}&lon=${t.coords.longitude}`)).json();e(F,u.display_name),g=[t.coords.longitude,t.coords.latitude],_&&_.remove(),_=new T.Marker({color:"#007bff"}).setLngLat([t.coords.longitude,t.coords.latitude]).addTo(r)}catch{e(F,""),g=null}A&&A.remove(),r&&M&&(A=new T.Marker({color:"#28a745"}).setLngLat(M).addTo(r))},t=>{e(n,"Aktifkan lokasi/GPS untuk menggunakan aplikasi."),console.error("Geolocation error:",t)})});const ae=async(o,t)=>{if(!O||!o){t==="pickup"?e(E,[]):e(I,[]);return}const[c,u]=O,f=.54,G=`${c-f},${u-f},${c+f},${u+f}`;try{const D=await(await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${o}&bounded=1&viewbox=${G}&limit=5`)).json();t==="pickup"?e(E,D):e(I,D)}catch(C){console.error("Error fetching suggestions:",C),t==="pickup"?e(E,[]):e(I,[])}},oe=(o,t)=>{t==="pickup"?(e(F,o.display_name),g=[parseFloat(o.lon),parseFloat(o.lat)],e(E,[]),_&&_.remove(),r&&g&&(_=new T.Marker({color:"#007bff"}).setLngLat(g).addTo(r),r.flyTo({center:g,zoom:r.getZoom()}))):(e(H,o.display_name),M=[parseFloat(o.lon),parseFloat(o.lat)],e(I,[]))},he=async()=>{if(!g||!M){e(n,"Mohon lengkapi lokasi penjemputan dan tujuan.");return}e(n,""),e(K,!1);const o=`https://router.project-osrm.org/route/v1/driving/${g.join(",")};${M.join(",")}?overview=full&geometries=geojson`;try{const c=await(await fetch(o)).json();if(c.routes&&c.routes.length>0){const u=c.routes[0],f=u.geometry.coordinates,G=new T.LngLatBounds;for(const Q of f)G.extend(Q);r.getSource("route")&&(r.removeLayer("route"),r.removeSource("route")),r.addSource("route",{type:"geojson",data:{type:"Feature",geometry:{type:"LineString",coordinates:f}}}),r.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#ff0000","line-width":4}}),r.fitBounds(G,{padding:40}),A&&A.remove(),r&&M&&(A=new T.Marker({color:"#28a745"}).setLngLat(M).addTo(r));const C=u.distance/1e3,D=Math.round(u.duration/60);e(b,{distance:`${C.toFixed(2)} km`,duration:`${D} menit`,tarif:`Rp ${(C*ge).toLocaleString("id-ID",{minimumFractionDigits:0,maximumFractionDigits:1})}`}),e(U,!0)}else e(b,null),e(n,"Tidak dapat menemukan rute. Coba lokasi lain.")}catch(t){console.error("Error finding route:",t),e(b,null),e(n,"Terjadi kesalahan saat mencari rute.")}};function ke(){e(U,!1)}const be=async()=>{if(!a(b)){e(n,"Mohon cari rute terlebih dahulu.");return}if(e(K,!0),e(n,"Mencari driver terdekat..."),await new Promise(o=>setTimeout(o,2e3)),e(K,!1),Math.random()>.1){e(n,"Driver ditemukan! Mengarahkan ke halaman konfirmasi...");const o={pickup:a(F),destination:a(H),pickupCoord:g,destinationCoord:M,routeInfo:a(b)},t=encodeURIComponent(JSON.stringify(o));te(`/order-confirm?data=${t}`)}else e(n,"Maaf, tidak ada driver yang tersedia saat ini. Coba lagi nanti.")},_e=async()=>{await ve.auth.signOut(),te("/login")};Me();var re=Se(),ye=Fe(re);{var je=o=>{var t=Ge(),c=l(t),u=l(c),f=l(u),G=l(f);i(f),i(u);var C=d(u,2);i(c);var D=d(c,4);{var Q=v=>{var m=Ie(),$=l(m),h=l($);ce(h);var J=d(h,2),V=d(J,2);{var N=s=>{var y=Re();le(y,5,()=>a(E),de,(k,j)=>{var w=Pe(),ee=l(w,!0);i(w),Z(()=>R(ee,a(j).display_name)),x("click",w,()=>oe(a(j),"pickup")),p(k,w)}),i(y),p(s,y)};z(V,s=>{a(E).length&&s(N)})}i($);var q=d($,2),P=l(q);ce(P);var X=d(P,2);{var B=s=>{var y=Ee();le(y,5,()=>a(I),de,(k,j)=>{var w=ze(),ee=l(w,!0);i(w),Z(()=>R(ee,a(j).display_name)),x("click",w,()=>oe(a(j),"destination")),p(k,w)}),i(y),p(s,y)};z(X,s=>{a(I).length&&s(B)})}i(q);var Y=d(q,2);i(m),ue(h,()=>a(F),s=>e(F,s)),x("input",h,s=>ae(s.target.value,"pickup")),x("click",J,fe),ue(P,()=>a(H),s=>e(H,s)),x("input",P,s=>ae(s.target.value,"destination")),x("click",Y,he),p(v,m)};z(D,v=>{a(U)||v(Q)})}var ie=d(D,2);{var we=v=>{var m=Oe(),$=l(m),h=d($,2),J=l(h),V=d(l(J));i(J);var N=d(J,2),q=d(l(N));i(N);var P=d(N,2),X=d(l(P));i(P),i(h);var B=d(h,2),Y=l(B);{var s=k=>{var j=se("Mencari driver...");p(k,j)},y=k=>{var j=se("Cari Driver");p(k,j)};z(Y,k=>{a(K)?k(s):k(y,!1)})}i(B),i(m),Z(()=>{R(V,` ${a(b).distance??""}`),R(q,` ${a(b).duration??""}`),R(X,` ${a(b).tarif??""}`),B.disabled=a(K)}),x("click",$,ke),x("click",B,be),p(v,m)};z(ie,v=>{a(U)&&a(b)&&v(we)})}var xe=d(ie,2);{var Le=v=>{var m=Ae(),$=l(m,!0);i(m),Z(h=>{De(m,1,`message ${h??""} rounded-lg`,"svelte-ibhmaj"),R($,a(n))},[()=>a(n).includes("Driver ditemukan")?"success":a(n).includes("Aktifkan lokasi")||a(n).includes("Mohon lengkapi")?"":"error"],ne),p(v,m)};z(xe,v=>{a(n)&&v(Le)})}i(t),Z(v=>R(G,`Halo, ${v??""}!`),[()=>a(W).email.split("@")[0]],ne),x("click",C,_e),p(o,t)};z(ye,o=>{a(W)&&o(je)})}p(me,re),Ce()}export{Ve as component};
